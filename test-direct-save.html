<!DOCTYPE html>
<html>
<head>
    <title>Test Directo - Settings</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
        }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            background: #3c3c3c;
            color: #d4d4d4;
            font-family: monospace;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #1177bb;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            font-size: 12px;
        }
        .success { border-left: 4px solid #4ec9b0; }
        .error { border-left: 4px solid #f48771; }
        .info { border-left: 4px solid #569cd6; }
        h1 { color: #4ec9b0; }
        label { color: #9cdcfe; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Directo de Guardado en Settings</h1>
        <p>Este test usa la API de Sheets directamente (sin Apps Script) para verificar si el problema est√° en Apps Script o en la comunicaci√≥n.</p>

        <label>Nombre de la App:</label>
        <input type="text" id="appName" value="TEST DIRECTO" placeholder="Nombre de la aplicaci√≥n">

        <label>URL del Logo:</label>
        <input type="text" id="logo" value="https://rangle.ec/img/ram.webp" placeholder="URL del logo">

        <button onclick="testDirectSheets()">üìä 1. Ver datos actuales en Settings</button>
        <button onclick="testAppsScriptSave()">üöÄ 2. Probar guardado via Apps Script</button>
        <button onclick="checkExecutions()">üîç 3. Ver √∫ltimas ejecuciones</button>

        <div id="result"></div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyMq4FGitikyxV0HeOxg-5gbWnYGHj67XiDH9nRUYZ_98yphh8X2Q2M1tXyftdbWKwT/exec';
        const SHEET_ID = '1jGKdkgzHBFLyXmAcGYKLF5dmjQhCtyaGPqWEJOhEi48';
        const API_KEY = 'AIzaSyC8llGU58K1JmLPsH1XAS-El3Px2sTf6-E';

        async function testDirectSheets() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'info';
            resultDiv.textContent = '‚è≥ Leyendo Settings directamente desde Google Sheets API...\n\n';

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Settings!A:B?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    resultDiv.className = 'error';
                    resultDiv.textContent = '‚ùå Error de Google Sheets API:\n\n' + JSON.stringify(data.error, null, 2);
                    return;
                }

                resultDiv.className = 'success';
                resultDiv.textContent = '‚úÖ Datos actuales en Settings:\n\n';
                resultDiv.textContent += JSON.stringify(data.values, null, 2);
                resultDiv.textContent += '\n\nüìä Interpretaci√≥n:\n';

                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    const values = data.values[1];
                    resultDiv.textContent += `  appName: ${values[0]}\n`;
                    resultDiv.textContent += `  logo: ${values[1] ? values[1].substring(0, 50) + '...' : '(vac√≠o)'}\n`;
                } else {
                    resultDiv.textContent += '  ‚ö†Ô∏è La hoja Settings est√° vac√≠a o solo tiene encabezados\n';
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.textContent = '‚ùå Error:\n\n' + error.message + '\n\n' + error.stack;
            }
        }

        async function testAppsScriptSave() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'info';
            resultDiv.textContent = '‚è≥ Paso 1: Verificando deployment...\n\n';

            try {
                // Primero verificar que el deployment est√° actualizado
                const testResponse = await fetch(APPS_SCRIPT_URL + '?test=config');
                const testData = await testResponse.json();

                resultDiv.textContent += 'üì° Respuesta del test endpoint:\n';
                resultDiv.textContent += JSON.stringify(testData, null, 2);
                resultDiv.textContent += '\n\n';

                if (!testData.success) {
                    resultDiv.className = 'error';
                    resultDiv.textContent += '‚ùå El deployment NO est√° actualizado.\n';
                    resultDiv.textContent += 'Actualiza el deployment en Apps Script antes de continuar.';
                    return;
                }

                resultDiv.textContent += '‚úÖ Deployment actualizado!\n\n';
                resultDiv.textContent += '‚è≥ Paso 2: Enviando POST para guardar...\n\n';

                const config = {
                    appName: document.getElementById('appName').value,
                    logo: document.getElementById('logo').value
                };

                const payload = {
                    operation: 'update',
                    type: 'config',
                    item: config
                };

                console.log('üì§ Payload:', payload);

                // Intentar POST con modo normal primero
                try {
                    const saveResponse = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        redirect: 'follow'
                    });

                    const saveText = await saveResponse.text();
                    resultDiv.textContent += 'üì• Respuesta del servidor:\n';
                    resultDiv.textContent += saveText + '\n\n';

                    try {
                        const saveData = JSON.parse(saveText);
                        if (saveData.success) {
                            resultDiv.className = 'success';
                            resultDiv.textContent += '‚úÖ ¬°GUARDADO EXITOSO!\n\n';
                        } else {
                            resultDiv.className = 'error';
                            resultDiv.textContent += '‚ùå Error en el guardado:\n';
                            resultDiv.textContent += JSON.stringify(saveData, null, 2);
                        }
                    } catch (e) {
                        resultDiv.textContent += '‚ö†Ô∏è Respuesta no es JSON\n';
                    }
                } catch (corsError) {
                    resultDiv.textContent += '‚ö†Ô∏è Error CORS (esperado en algunos navegadores)\n';
                    resultDiv.textContent += 'Intentando con modo no-cors...\n\n';

                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        mode: 'no-cors'
                    });

                    resultDiv.textContent += '‚úÖ Petici√≥n enviada en modo no-cors\n';
                    resultDiv.textContent += '‚ö†Ô∏è No se puede verificar respuesta en este modo\n\n';
                    resultDiv.textContent += 'üîç Verifica en Apps Script ‚Üí Ejecuciones si lleg√≥ la petici√≥n\n';
                }

                // Esperar y verificar
                resultDiv.textContent += '\n‚è≥ Esperando 2 segundos...\n';

                setTimeout(async () => {
                    const verifyResponse = await fetch(APPS_SCRIPT_URL + '?test=config&_=' + Date.now());
                    const verifyData = await verifyResponse.json();

                    resultDiv.textContent += '\nüìä Verificaci√≥n (datos despu√©s del guardado):\n';
                    resultDiv.textContent += JSON.stringify(verifyData.settingsData, null, 2);
                }, 2000);

            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.textContent += '\n‚ùå Error:\n\n' + error.message + '\n\n' + error.stack;
            }
        }

        function checkExecutions() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'info';
            resultDiv.textContent = 'üìã Para ver las ejecuciones de Apps Script:\n\n';
            resultDiv.textContent += '1. Abre tu Google Sheet\n';
            resultDiv.textContent += '2. Extensiones ‚Üí Apps Script\n';
            resultDiv.textContent += '3. Click en el √≠cono de reloj (‚è∞) en el men√∫ izquierdo\n';
            resultDiv.textContent += '4. Verifica si hay ejecuciones recientes\n';
            resultDiv.textContent += '5. Click en cada ejecuci√≥n para ver los logs\n\n';
            resultDiv.textContent += 'üîç Busca logs que digan:\n';
            resultDiv.textContent += '  - "üîî doPost llamado"\n';
            resultDiv.textContent += '  - "üîß Operaci√≥n incremental: config - update"\n';
            resultDiv.textContent += '  - "üìù handleConfigOperation llamada"\n';
            resultDiv.textContent += '  - "‚úÖ Configuraci√≥n actualizada en Settings"\n\n';
            resultDiv.textContent += '‚ùå Si NO ves ejecuciones recientes:\n';
            resultDiv.textContent += '  ‚Üí El Apps Script NO est√° recibiendo las peticiones\n';
            resultDiv.textContent += '  ‚Üí Verifica que la URL del deployment sea correcta\n';
        }
    </script>
</body>
</html>
